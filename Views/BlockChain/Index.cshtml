@model IEnumerable<BlockChain_FP_ITStep.Models.BlockValidationViewModel>

@{
    ViewData["Title"] = "Blockchain Index";

    var mempool = ViewBag.Mempool as List<Transaction>;
    var mempoolCount = (int)ViewBag.MempoolCount;
    var wallets = ViewBag.Wallets as List<Wallet>;
    var balances = ViewBag.Balances as Dictionary<string, decimal>;
    var nodeId = @ViewBag.NodeId as string;
}

<style>
    body {
        background-color: #0d1117;
        color: #e6edf3;
        font-family: 'Segoe UI', sans-serif;
    }

    h2, h3, h4 {
        color: #58a6ff;
    }

    .alert {
        border-radius: 8px;
    }

    .form-control, .form-control-modern, textarea {
        background-color: #161b22;
        color: #e6edf3;
        border: 1px solid #30363d;
    }

        .form-control::placeholder {
            color: #8b949e;
        }

    .btn, .btn-control-primary, .btn-control-secondary, .btn-keygen {
        border: none;
        color: #e6edf3;
    }

    .btn-control-primary, .btn-keygen {
        background-color: #238636;
    }

        .btn-control-primary:hover, .btn-keygen:hover {
            background-color: #2ea043;
        }

    .btn-control-secondary {
        background-color: #30363d;
    }

        .btn-control-secondary:hover {
            background-color: #484f58;
        }

    table {
        color: #c9d1d9;
    }

        table th, table td {
            border-color: #30363d;
        }

        table thead th {
            background-color: #21262d;
            color: #e6edf3;
        }

        table tbody tr:hover {
            background-color: #2d333b;
        }

    .table-success {
        background-color: #1f6a20 !important;
        color: #e6edf3;
    }

    .table-danger {
        background-color: #831f1f !important;
        color: #e6edf3;
    }

    .control-card {
        background-color: #161b22;
        border: 1px solid #30363d;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 0 8px rgba(88,166,255,0.15);
    }

    .card-title {
        font-weight: bold;
        color: #58a6ff;
        margin-bottom: 10px;
    }

    .stats-container {
        display: flex;
        gap: 15px;
    }

    .stat-card {
        background-color: #161b22;
        border: 1px solid #30363d;
        border-radius: 12px;
        flex: 1;
        text-align: center;
        padding: 10px;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #8b949e;
    }

    .stat-value {
        font-weight: bold;
        font-size: 1.2rem;
        color: #e6edf3;
    }

    .toast-container .toast {
        background-color: #21262d;
        color: #e6edf3;
    }

    .copyable {
        cursor: pointer;
        color: #58a6ff;
    }

        .copyable:hover {
            text-decoration: underline;
        }
</style>

<div class="container py-4">

    <!-- Alerts -->
    @if (ViewBag.IsChainValid == true)
    {
        <div class="alert alert-success">Blockchain is valid</div>
    }
    else
    {
        <div class="alert alert-danger">Blockchain integrity compromised!</div>
    }

    @if (ViewBag.SearchMessage != null)
    {
        <div class="alert alert-warning mt-3">@ViewBag.SearchMessage</div>
    }

    <!-- Node Keys -->
    <div class="node-keys-section mb-4 d-flex gap-3">
        <div class="flex-fill">
            <label class="form-label">Private Key</label>
            <textarea class="form-control" rows="6" readonly onclick="copyToClipboard('@ViewBag.NodePrivateKey', 'Private Key')">@ViewBag.NodePrivateKey</textarea>
            <small class="text-muted">Click to copy</small>
        </div>
        <div class="flex-fill">
            <label class="form-label">Public Key</label>
            <textarea class="form-control" rows="6" readonly onclick="copyToClipboard('@ViewBag.NodePublicKey', 'Public Key')">@ViewBag.NodePublicKey</textarea>
            <small class="text-muted">Click to copy</small>
        </div>
    </div>

    <hr />

    <!-- Stats -->
    <div class="blockchain-stats mb-4">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">Difficulty</div>
                <div class="stat-value">@ViewBag.Difficulty</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Mining Reward</div>
                <div class="stat-value">@ViewBag.CurrentReward <i class="bi bi-coin"></i></div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel mb-4">
        <form method="get" asp-action="Index" class="node-selector mb-3 d-flex gap-2 align-items-center">
            <label>Node:</label>
            <select name="nodeId" class="form-control form-control-sm">
                @foreach (var n in ViewBag.Nodes)
                {
                    <option value="@n" selected="@(n == ViewBag.NodeId ? "selected" : null)">@n</option>
                }
            </select>
            <button type="submit" class="btn btn-control-primary btn-sm">Switch</button>
        </form>

        <div class="row g-3">
            <div class="col-lg-8">
                <div class="control-card">
                    <div class="card-title"><i class="bi bi-minecart-loaded"></i> Mining Controls</div>

                    <div class="d-flex flex-wrap gap-2">
                        <form method="post" asp-action="DemoSetup" class="d-inline">
                            <input type="hidden" name="nodeId" value="@nodeId" />
                            <button type="submit" class="btn btn-control-secondary btn-sm"><i class="bi bi-play-circle me-1"></i> Demo Setup</button>
                        </form>

                        <form method="post" asp-action="MinePending" class="d-flex gap-2 flex-grow-1">
                            <input type="hidden" name="nodeId" value="@nodeId" />
                            <input type="text" name="privateKey" class="form-control form-control-sm flex-grow-1" placeholder="Enter private key for mining" style="max-width: 350px;" />
                            <button type="submit" class="btn btn-control-primary btn-sm"><i class="bi bi-play-fill me-1"></i> Start Mining</button>
                        </form>
                    </div>

                    <div id="miningProgress" class="mt-3" style="display:none;">
                        <div class="progress" style="height:6px; background:#21262d;">
                            <div id="progressBarInline" class="progress-bar bg-success" role="progressbar" style="width:0%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2 text-muted">
                            <small id="progressText">⛏️ Mining block...</small>
                            <small id="attemptsText">0 attempts/s</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="control-card">
                    <div class="card-title"><i class="bi bi-sliders"></i> Difficulty Settings</div>
                    <form method="post" asp-action="SetDifficulty" novalidate>
                        <input type="hidden" name="nodeId" value="@nodeId" />
                        <div class="input-group input-group-sm">
                            <input type="number" name="difficulty" class="form-control" placeholder="New difficulty" min="1" />
                            <button type="submit" class="btn btn-control-primary">Apply</button>
                        </div>
                        <div class="mt-1">Current difficulty: <strong>@ViewBag.Difficulty</strong></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallets & Mempool -->
    <div class="mb-4">
        <h3>Register Wallet</h3>
        <form method="post" asp-action="RegisterWallet" class="d-flex gap-2 flex-wrap">
            <input type="hidden" name="nodeId" value="@nodeId" />
            <input type="text" name="displayName" class="form-control form-control-sm" placeholder="Wallet owner name" />
            <input type="text" name="publicKeyXml" class="form-control form-control-sm" placeholder="Public Key XML" />
            <button type="submit" class="btn btn-control-primary btn-sm">Register Wallet</button>
        </form>

        @if (wallets != null && wallets.Count > 0)
        {
            <table class="table table-dark table-hover table-bordered align-middle text-light">
                <thead class="table-dark text-light">
                    <tr>
                        <th>Address</th>
                        <th>Name</th>
                        <th>Amount</th>
                        <th>PublicKey</th>
                        <th>RegisteredAt</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var w in wallets)
                    {
                        <tr class="align-middle">
                            <td>
                                <a asp-controller="Wallet"
                                   asp-action="Index"
                                   asp-route-address="@w.Address"
                                   class="text-white text-decoration-none"
                                   style="cursor:pointer;"
                                   onmouseover="this.classList.remove('text-white'); this.classList.add('text-primary')"
                                   onmouseout="this.classList.add('text-white'); this.classList.remove('text-primary')">
                                    @w.Address
                                </a>
                            </td>
                            <td>@w.DisplayName</td>
                            <td>@(balances != null && balances.ContainsKey(w.Address) ? balances[w.Address] : 0)</td>
                            <td title="@w.PublicKeyXml" onclick="copyToClipboard('@w.PublicKeyXml', 'Public Key')" style="cursor:pointer;">
                                @(w.PublicKeyXml?.Length > 20 ? w.PublicKeyXml.Substring(0, 20) + "..." : w.PublicKeyXml)
                            </td>
                            <td>@w.RegisteredAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p class="text-light">No wallets yet.</p>
        }

        <h3 class="mt-4">Memory Pool</h3>
        <form method="post" asp-action="CreateTransaction" class="d-flex gap-2 flex-wrap mb-3">
            <input type="hidden" name="nodeId" value="@nodeId" />
            <input name="fromAddress" type="text" class="form-control form-control-sm" placeholder="From Address (ADDR_...)" />
            <input name="toAddress" type="text" class="form-control form-control-sm" placeholder="To Address (ADDR_...)" />
            <input name="Amount" type="number" class="form-control form-control-sm" placeholder="Amount" />
            <input name="fee" type="number" step="0.01" class="form-control form-control-sm" placeholder="Fee" />
            <input name="privateKey" type="text" class="form-control form-control-sm" placeholder="Private Key" />
            <input name="note" type="text" class="form-control form-control-sm" placeholder="Note" />
            <button type="submit" class="btn btn-control-primary btn-sm">Add to mempool</button>
        </form>

        @if (mempool != null && mempool.Count > 0)
        {
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>From</th>
                        <th>To</th>
                        <th>Amount</th>
                        <th>Fee</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var m in mempool)
                    {
                        <tr>
                            <td>@m.FromAddress</td>
                            <td>@m.ToAddress</td>
                            <td>@m.Amount</td>
                            <td>@m.Fee</td>
                            <td>@m.Note</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>

</div>
<div class="container mt-4">
    <h2 class="text-center mb-4">Blockchain Blocks</h2>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var item in Model)
        {
            bool isValid = item.IsValid;
            bool sigValid = item.IsSignatureValid;
            bool isGenesis = item.Block.Index == 0; // Генезис-блок
            string borderClass = isGenesis ? "border-warning" : (isValid ? "border-success" : "border-danger");

            <div class="col">
                <div class="card text-light bg-dark border-2 @borderClass h-100 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><strong>Block #@item.Block.Index</strong></span>
                        <span class="badge @(isValid ? "bg-success" : "bg-danger")">
                            @(isValid ? "Valid" : "Invalid")
                        </span>
                    </div>
                    <div class="card-body">
                        <p><strong>Nonce:</strong> @item.Block.Nonce</p>
                        <p>
                            <strong>Mining Duration:</strong>
                            @{
                                var seconds = item.Block.MiningDurationMs / 1000.0;
                            }
                            @($"{seconds:F2} s")
                        </p>
                        <p><strong>Difficulty:</strong> @item.Block.Difficulty</p>
                        <p><strong>Reward:</strong> @item.Reward</p>

                        <p>
                            <strong>PrevHash:</strong>
                            <span class="copyable" title="@item.Block.PrevHash"
                                  onclick="copyToClipboard('@item.Block.PrevHash', 'PrevHash')">
                                @(item.Block.PrevHash?.Length > 16 ? item.Block.PrevHash.Substring(0, 16) + "..." : item.Block.PrevHash)
                            </span>
                        </p>
                        <p>
                            <strong>Hash:</strong>
                            <span class="copyable" title="@item.Block.Hash"
                                  onclick="copyToClipboard('@item.Block.Hash', 'Hash')">
                                @(item.Block.Hash?.Length > 16 ? item.Block.Hash.Substring(0, 16) + "..." : item.Block.Hash)
                            </span>
                        </p>

                        <p><strong>Timestamp:</strong> @item.Block.Timestamp</p>

                        <p>
                            <strong>Signature:</strong>
                            <span class="copyable" title="@item.Block.Signature"
                                  onclick="copyToClipboard('@item.Block.Signature', 'Signature')">
                                @(item.Block.Signature?.Length > 16 ? item.Block.Signature.Substring(0, 16) + "..." : item.Block.Signature)
                            </span>
                        </p>

                        <p>
                            <strong>Signature Status:</strong>
                            <span class="badge @(sigValid ? "bg-success" : "bg-danger")">
                                @(sigValid ? "Valid" : "Invalid")
                            </span>
                        </p>
                    </div>
                    <div class="card-footer text-center">
                        @Html.ActionLink("Edit", "Edit", new { index = item.Block.Index }, new { @class = "btn btn-sm btn-outline-info me-1" })
                        @Html.ActionLink("Details", "Details", new { id = item.Block.Id }, new { @class = "btn btn-sm btn-outline-light me-1" })
                        @Html.ActionLink("Delete", "Delete", new { id = item.Block.Id }, new { @class = "btn btn-sm btn-outline-danger" })
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
           function copyToClipboard(text, label) {
            navigator.clipboard.writeText(text)
                .then(() => showToast(`${label} copied to clipboard`))
                .catch(() => showToast("Failed to copy", true));
        }

        function showToast(message, isError = false) {
            const toastEl = document.getElementById('toastMessage');
            toastEl.querySelector('.toast-body').textContent = message;
            toastEl.classList.remove('bg-success','bg-danger');
            toastEl.classList.add(isError ? 'bg-danger' : 'bg-success');
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
        }
    </script>
}
